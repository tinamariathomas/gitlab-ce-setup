version: '2'
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab-local
    hostname: gitlab.example.com
    ports:
      - "80:80"
      - "8443:443"
      - "2222:22"
    environment:
      - GITLAB_ROOT_PASSWORD=1234root
      - GITLAB_OMNIBUS_CONFIG="external_url 'http://gitlab.example.com:80'; gitlab_rails['gitlab_shell_ssh_port']=2222;"
    volumes:
      - ${HOME}/gitlab-data/config:/etc/gitlab
      - ${HOME}/gitlab-data/logs:/var/log/gitlab
      - ${HOME}/gitlab-data/data:/var/opt/gitlab

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    dns_search: gitlab.example.com
    extra_hosts:
      - "gitlab.example.com:172.18.0.2"
    volumes:
      - ${HOME}/gitlab-runner/config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
        - CI_SERVER_URL=http://gitlab.example.com/
        - REGISTRATION_TOKEN=Ln7_5ErzcYgWgmxr5t3m
        - RUNNER_NAME=gradle_docker
        - RUNNER_EXECUTOR=docker
        - DOCKER_IMAGE=gradle
# Notice that it matches exactly the network found in docker network ls
        - DOCKER_NETWORK_MODE=gitlab_gitlab_net
        - DOCKER_EXTRA_HOSTS=gitlab.example.com:172.18.0.2
